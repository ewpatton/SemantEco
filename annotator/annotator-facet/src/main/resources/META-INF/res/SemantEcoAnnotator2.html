<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Semantic Annotator</title>

	<style>
	
    body {
      font: 12px/20px "Lucida Grande", Tahoma, Verdana, sans-serif;
      color: #404040;
      background: #47496D;
      background-image: -webkit-radial-gradient(center, circle cover, #6b6e8c, #212649);
      background-image: -moz-radial-gradient(center, circle cover, #6b6e8c, #212649);
      background-image: -o-radial-gradient(center, circle cover, #6b6e8c, #212649);
      background-image: radial-gradient(center, circle cover, #6b6e8c, #212649);
    }
    #wrap{
      margin: 10px auto;
      width: 960px;
      padding: 10px;
      overflow: hidden;
      background: #FAFAFA;
      border-radius: 4px;
      -webkit-box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    }
    form{
      background: #CCC;
      border-radius: 2px;
      padding: 10px;
    }
    table {
      max-width: 100%;
      background-color: #fff;
      border-collapse: collapse;
      border-spacing: 0;
      width: 100%;
      margin-bottom: 20px;
    }
    table th{
      background: #eae4ff;
    }
    table th,
    table td {
      padding: 8px;
      line-height: 20px;
      text-align: left;
      vertical-align: top;
      border-top: 1px solid #dddddd;
    }
    table {
      border: 1px solid #dddddd;
      border-collapse: separate;
      *border-collapse: collapse;
      border-left: 0;
      -webkit-border-radius: 4px;
         -moz-border-radius: 4px;
              border-radius: 4px;
    }
    table th,
    table td {
      border-left: 1px solid #dddddd;
    }

    table tr:nth-child(odd){
      background-color: #f9f9f9;
    }

    table tr:hover td
    {
      background-color: #f5f5f5;
    }

    table tr:first-child{
      font-weight: bold;
    }
	</style>

	<script type="text/javascript" src="../../js/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="js/jquery.csvToTable.js"></script>
	<script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
	<script type="text/javascript" src="../../js/jstree/jquery.jstree.js"></script>
	<!-- <script type="text/javascript" src="_docs/syntax/!script.js"></script> -->
	<script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
    <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
    
    <script type="text/javascript" src="../../js/jquery.ba-bbq-1.2.1.js"></script>
    <script type="text/javascript" src="../../js/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../js/modernizr-2.0.js"></script>
    <script type="text/javascript" src="../../js/d3.js"></script>
    <script type="text/javascript" src="../../js/d3.csv.js"></script>
    <script type="text/javascript" src="../../js/d3.time.js"></script>
    <script type="text/javascript" src="../../js/json.js"></script>
    <script type="text/javascript" src="../../js/SemantEco.js"></script>
    <script type="text/javascript" src="../../js/SemantEcoUI.js"></script>
    <script type="text/javascript" src="../../js/SemantEcoUI.HierarchicalFacet.js"></script>
    <script type="text/javascript" src="../../js/config.js"></script>
    <script type="text/javascript" src="../../js/modules/AnnotatorModule.js"></script>
    <script type="text/javascript" src="../../js/jqplot/jquery.jqplot.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../js/jqplot/jquery.jqplot.min.css" />
    <script type="text/javascript" src="../../js/jqplot/plugins/jqplot.highlighter.js"></script>
    <script type="text/javascript" src="../../js/jqplot/plugins/jqplot.cursor.min.js"></script>
    <script type="text/javascript" src="../../js/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>
	 
	<script type="text/javascript" class="source below">
	 /*jsonHier used to accept JSON*/
	 var jsonHier;
//	jsonHier = String(jsonHier); // Cast to string
	/*class_hierachy used to store nodes information*/
	 var class_hierachy=new Array();
	 var temp_array;
	 var class_hierachy_temp=new Array();
	 var class_hierachy_map=new Array();

	/*initialization*/
	$(function() {
		/*get the root node by SpeciesDataProviderModule.queryeBirdTaxonomyRoots*/
		//puts the array of root nodes, which are in the "data" array, into jsonHier
		//call initial_hiearchy
						AnnotatorModule.queryForAnnotatorRootClasses({}, function (data){
	        	    		  jsonHier=JSON.parse(data);
	        	    		  jsonHier=jsonHier["data"];
	        	    		  initial_hierachy();
	        	    		  
	        	    		          	    		  
	        	       }
	        	       );
	        	});
	 
	 //var class_hierachy=[["Aves",null],["Accipiter","Aves"],["Acanthis","Aves"],["Aechmophorus","Aves"],["sharpShinnedHawk","Accipiter"],["commonRedpoll","Acanthis"]];


	 var show=new Array();
	 var len=0;

	 
	function initial_hierachy(){
		/*put root node in class_hierachy_temp and class_hierachy*/
		var flag=0;
		for (var i=0;i<jsonHier.length;i++){
			flag=0;
			for (var j=0;j<jsonHier.length;j++){
				//looking in the "parent" value and get the index position of the "#"		
				//use the temp1, which is the index, to access the string of the parent uri (http://ebird#birdTaxonomy becomes birdTaxonomy) and compare with the label of the current json in jsonHier
				//in the case of birdTaxonomy, which is not one of the Ids, this will never be true.
				if(jsonHier[i]["parent"]==jsonHier[j]["id"]){
					flag=1;
					break;
				}
			}
			if(flag==0){
				var flag1=0
				//at the first iteration class_hierarchty_temp will be empty
				//this loop compares every element in 2-d array class_hierarchy_temp with the parent of each species json
				for (var k=0;k<class_hierachy_temp.length;k++){
					if(class_hierachy_temp[k][2]==jsonHier[i]["parent"]){
						flag1=1;
						break;
					}
			
				}
				//first time iteration always true
				//so flag1 will be 1 and the below will not be entered when birdTaxonomy is in the class_hierarchy_temp array
				//so the push below just collects all the parents for the 2nd level and all level (depending on the array).
				if(flag1==0){
					//will put birdTaxonomy (the short name) into class_hierarchy_temp
					//class_hierarchy_temp only includes 1st and 2nd level nodes
					var temp=jsonHier[i]["parent"].indexOf("#");
					class_hierachy_temp.push(new Array(jsonHier[i]["parent"].substring(temp+1),null,jsonHier[i]["parent"]));
					//class_hierarchy includes all nodes
					//"parent" here is accessing within the json array and "parent" is accesing into the json array.
					class_hierachy.push(new Array(jsonHier[i]["parent"].substring(temp+1),null,jsonHier[i]["parent"]));
				}
			}
		}
		

		
		/*iterate nodes in class_hierachy_temp to build tree*/
		//this loop puts all 2nd tier classes into class_hierarchy under the root class(es). but it does not build the tree yet.
		for (var j=0;j<class_hierachy_temp.length;j++){ //just birdTaxonomy
			 for (var i=0;i<jsonHier.length;i++){ //all of the second level nodes
				 			 	
				 	//the below will always be true because each has the parent birdTaxonomy
					if(jsonHier[i]["parent"]==class_hierachy_temp[j][2]){
						
						//this creates an array of for example "Struthioniformes", "birdTaxonomy", "http://ebird#Struthioniformes"
						//so the class_hierarchy_temp only has the root-most node
						//the class_hierarchy has the id, label, and parent of all the second level classes
						class_hierachy.push(new Array(jsonHier[i]["label"],jsonHier[i]["parent"],jsonHier[i]["id"]));
						
						//jsonHier.remove(i);
					}
			 }
			
		}
		
		//the next thing is to build the tree that goes into the DIV,  using class_hierachy_temp for finding the root ONLY, and also using class_hierarchy array 
		/*get the nodes information from class_hierachy and then build JStree*/
		//here we are getting the div for the tree
		var temp_div=document.getElementById('tree');
		temp_div.innerHTML="";
		
		//all below here is to help jstree to build the tree
		for (var i=0;i<class_hierachy_temp.length;i++){
			//the jstree uses a ul, li, and a to make one node.
			var ul=document.createElement("ul");
			var li=document.createElement("li");
			var a=document.createElement("a");
			a.href="#";
			//this is a javascript method
			var text=document.createTextNode(class_hierachy_temp[i][0]);
			/** this is the most important identifer because it links the tree information contained in the class_hierarchy array and the jstree structure*/
			li.id=i;
			//this builds the structure to use the ul to put into the div.
			a.appendChild(text); 
			li.appendChild(a); 
			ul.appendChild(li); 
			//put the ul into the div
			temp_div.appendChild(ul); 
			//"description" is part of the speciesHierarchy.jsp above the tree div
			document.getElementById('description').appendChild(temp_div);
			
			var j;
			
			
			/*append second level nodes to the root level node in the DIV. append_node is a function below*/
		    for ( j=class_hierachy_temp.length;j<class_hierachy.length;j++){ 
		    	//i is the id of the root level node, which is always 0.
		    	//and the j is 1 (because only one in the parent array) to length of the class hierarchy
		    	//j here is the index of the node in the class_hierarchy
				append_node(j,i);
			}
		    
		}
		//see the output of the objects being dragged and dropped 
		function printObject(o) {
			  var out = '';
			  for (var p in o) {
			    out += p + ': ' + o[p] + '\n';
			  }
			  alert(out);
			}
		
		
		
		/** JStree function, initialize JStree. make all nodes open at first*/
		$(function () {
			//here we applying the jstree method (.jstree) into the #tree div which has a tree.
			$("#tree")
				.jstree({
					"themes" : {
	   					 "theme" : "default",
	   					 "dots" : true,
	  					 "icons" : true,
				 	     "url": "../../js/jstree/themes/default/style.css"
						},
						 
					"core" : { "initially_open" : [ "0" ] },
					
					"dnd" : {
   		                "drop_target" : "#list th",
   		                "drop_finish" : function (data) {
   		                	$(data.r).css("background-color","#00ff00");
                         //add the node name to the header, and get the parent node "id"
   		                 var p = data.o.attr("id");
   		                 //alert(p);

   		                 var q = $(data.o).text();
   		                 //alert(q);
   		                 
   		                 var i = data.r.attr("id");
   		                 //alert(i);
   		                 
   		                 var r = $(data.r).text();
   		                 //alert(r);
   		                 
   		                 var cn = i.split(',')[1];
   		                 
   		                 if (window.classRow ==1){
   		                 $("[id='classRow,"+cn+"']").text(q.replace(/^\s+|\s+$/g,''));   		                	 
   		                 }
   		              
   		                 else
   		                 {
   		                 var tr = "<tr id='classRow'>";
   		                 for (var j = 0; j < window.column_numbers; ++j) {
   		                	 tr+="<td id='classRow,"+j+"'>";
   		                	 if (j == cn) tr += q.replace(/^\s+|\s+$/g,'');
   		                	 tr += "</td>";
   		                 }
   		                 tr+= "</tr>";
   		                 $('#list tr:first').after(tr);
   		                 window.classRow = 1;
   		                 }
   		                 
   		            //  window.annotationMappings = {"RangeClass":[{"classname":"url"}], "Property":[{"propertyname": "url"}]};
   		                 
   		            //    var args = {};
   		            //    args[r] = p;
   		            
   		            function keySearch(dict,key) {
   		            	for (var i in dict) if (key in dict[i]) 
   		            		return dict[i][key];
   		            	return null;                               		            
   		            }
   		            
   		            var am = window.a
   		            var kg = keySearch(am,r);
   		            var args = {};
   		            args[r]  = {"RangeClass":p};
   		           
   		            if (kg!=null){   		            	
   		            	kg["RangeClass"] = p;   		            
   		            }            
			        else{
				        am.push(args);
			        };
/*                         
   		                 for (i in annotationMappings) {
   		            	 for (j in annotationMappings[i][0]) {
   		            	 alert(j+":"+annotationMappings[i][0][j]);
   		            	 }
   		            	 }
   		 
   		              
   		                 for (i in annotationMappings) {
   		            	 if ($.isArray(annotationMappings[i])) {
   		            	 alert(i + ": " + "Array["+annotationMappings[i].length+"]<br />");
   		            	 } else {
   		            	 alert(i + ": Object<br />");
   		            	 }
   		            	 }	            	  
*/   		                
   		                }
   		            },
   		            
   		            "crrm" : { move : { check_move : function (m) { return false; } } },

					
					 "plugins" : ["themes","html_data","dnd","ui","types","crrm"] })
						
		                /**the function used for selecting one node*/
					 //this retrieve the children node of the selected node, based on user selection of the node in the tree. (see: queryBirdTaxonomySubclasses below)
					 //this bind method applies the select_node.jstree action to this function
						.bind("select_node.jstree", function (event, data) { 
						
							
							//this is a jstree method for getting the id for the node you selected, this id is the index into the array.
						    var temp=data.rslt.obj.attr("id");
						    /*use $.bbq.pushState to put in queryeBirdTaxonomySubClasses's information*/
						    //the [2] index is the id of the species
						    $.bbq.pushState({"SubClass":class_hierachy[temp][2]});
						    /*ajax_node will work on JSON returned from backend*/
						    //here the method ajax_node will execute the server method for retrieving subclass nodes.
							ajax_node();					
							getSelectedValue();
					})
					    
					
					
						//    if not using the UI plugin - the Anchor tags work as expected
						//    so if the anchor has a HREF attirbute - the page will be changed
			
						.delegate("a", "click", function (event, data) { event.preventDefault(); })
		});

	}

	/** This function handles the deselection of the parent node when CTRL is selected, and it also pushes the bbq state all the selected species nodes.
	 * This method is executed anytime a  */
	function getSelectedValue() {  
		/*get every nodes which you selected*/
	    var nodes = $.jstree._reference($("#tree")).get_selected();
	    var temp=new Array();
	    /** this method is basically a "cleanup" to deselect the a parent node after a click on a child node.*/
	    $.each(nodes, function(i, n) {  
	    	 /*if one node and its parent node both be selected, parent node will be deselected*/
	    	for (var i=0;i< nodes.length;i++){
	    		//the first in the comparison is the parent in index 1, and the second is the current node that you have selected in the get_selected list
	    		//so if it matches then you remove the parent node
	    		//class_hiear[this.id][1] = references the parent of the current selected node
	    		//class_hiear[nodes[i].id][2] use nodes[i].id, which is the position in the class_hierarchy array of the selected node being iterated over,
	    		// and then using [2] index to access the identifer.
	    		//in summary we are comparing the currently current node's parent identifier with every selected nodes id using the class_hiearchy array, accessing its position and then identifer
	    		//the position of each node in the class_hierarchy array is also stored in the node. 
	    		/*
	    		 * class_hierachy
					Array[3]
				0: "Struthioniformes"
				1: "http://ebird#birdTaxonomy"
				2: "http://ebird#Struthioniformes"
				length: 3
					__proto__: Array[0]
	    		 *
	    		 */
	    		
	    		if(class_hierachy[this.id][1]==class_hierachy[nodes[i].id][2]){
	    			//this deselects the parent node
	    			$.jstree._reference($("#tree")).deselect_node(nodes[i]);
	    			break;
	    		}  		
	    	};   
	    }); 
	    
	    /*put all select node's ID in $.bbq*/
	    nodes = $.jstree._reference($("#tree")).get_selected();
	    $.each(nodes, function(i, n) {  
	    	temp.push(class_hierachy[this.id][2]);
	    });
	    $.bbq.pushState({"species":temp});
	}  

	/** build second layer nodes
	for the first iteration, the  current variable is 1 and parent is 0 */
	function append_node(current, parent){
		
		//find the child nodes of one parent node and put them under that id under the parent element (by getElementById)
		// so class_hierachy[parent][0] is always class_hierachy[0][0] and thus always "birdTaxonomy".
		//we use class_hierachy[current][1] because [1] is the parent label so [1] is really ["parent"]
	    if(class_hierachy[current][1]==class_hierachy[parent][2]){
			var temp_div=document.getElementById(parent);
			var ul=document.createElement("ul");
			var li=document.createElement("li");
			var a=document.createElement("a");
			a.href="#";
			//when it matches the birdTaxonomy parent, then we take the id, which is the 0 index to create the text node.
			var text=document.createTextNode(class_hierachy[current][0]);
			li.id=current;
			a.appendChild(text); 
			li.appendChild(a); 
			ul.appendChild(li); 
			temp_div.appendChild(ul); 
		 	    
			//alert("success");
			
		}	
	}	


	/**this method is called only if a node is selected/clicked AND it builds children nodes.
	if multiple nodes are selected it will be executed once for each node
	the execution finishing depends on whether JSON is returned from queryeBNirdTaxonomySubclasses */
	function ajax_node() {
		AnnotatorModule.queryForAnnotatorSubClasses({}, function(data) {
			jsonHier = JSON.parse(data);
			jsonHier = jsonHier["data"];
			var flag=0;
			var id=0;
			
			//if the subclassses returned is empty
			if (jsonHier.length == 0) {
				//alert("null");
			} else {
				for ( var parent = 0; parent < class_hierachy.length; parent++) {
					if (jsonHier[0]["id"] == class_hierachy[parent][2]) {
						flag = 1;
						break;
					}
				}
				if (flag == 1) {
					//alert("error");
				} else {
					//alert("success");
					for ( var i = 0; i < jsonHier.length; i++) {
						for ( var parent = 0; parent < class_hierachy.length; parent++) {
							
							//find the parent node for each returned subclass
							//comparing the parent field of the node string with the label of the class nodes label in the class hierarchy.
							if (jsonHier[i]["parent"] == class_hierachy[parent][2]) { 
								id=parent;
								var temp_div = document.getElementById(parent);
								var ul = document.createElement("ul");
								var li = document.createElement("li");
								var a = document.createElement("a");
								a.href = "#";
								var text = document.createTextNode(jsonHier[i]["label"]);
								li.id = class_hierachy.length;
								a.appendChild(text);
								li.appendChild(a);
								ul.appendChild(li);
								temp_div.appendChild(ul);
								// alert("success");
								class_hierachy.push(new Array(jsonHier[i]["label"],jsonHier[i]["parent"],jsonHier[i]["id"]));
								break;
							}
						}
					}
					 /*unfold children nodes*/
					var tree = jQuery.jstree._reference("#" + id);
			        tree.refresh();
			        document.getElementById(id).firstChild.click();
				}
			}
			
		});
	}


	document.onkeydown = keyDown;
	/**the funciton handle "delete" key
	 * this function listened to event every time you use the delete key / backspace in the search box.
	 * 
	 * */
	function keyDown(){
	     if(event.keyCode==8){
	    	 //temp is the string you entered
	     	var temp =document.getElementById('search_info').value;
	     
	    	var cprStr=temp;
	    	//if the length of the search string is not 1 or 0
	     	if(cprStr.length!=1&&cprStr.length!=0){   
	     		//pressing delete adds a 8 character to the end of string anytime you press delete, thus length -1.
	     		cprStr=cprStr.substring(0,cprStr.length-1);   
	     		//temp array for holding matching nodes
	    		show=[];
	    		len=0;
	    		//this loop looks for the string that is search in every label
	    		for (i in class_hierachy){
	    			//check whether search string is inside of the label string
	     			if(cprStr==class_hierachy[i][0].substring(0,cprStr.length)){
	    	    		len=show.push(class_hierachy[i][0]);
	        		}
	     		} 
	    	 }
	 	 else{
	 	show=[] //clearing the show array
	         }
	    	 //alert("Have "+len+" compatible records");
	     	
	     	//we create a new div for showing the matched nodes
	     	//by having a show element, anything you put in the div will appear
		  var div1=document.getElementById('show');
	   	  div1.innerHTML="";
	   	  htmlStr="";
	   	  //this 
	   	  for (i in show){
	      	  htmlStr+="<a style=\"cursor: pointer;\" onclick=\"choose(this)\">"
	       	  htmlStr+=show[i];
			  htmlStr+="</a>"
	          htmlStr+="</br>";
	     }
		  div1.innerHTML+=htmlStr;
	    	  //alert(show);
	     }
	     
	 }

	/**handle other key except "delete" key*/
	function press(event){
	 var e=event.srcElement;
	     if(event.keyCode!=13){
	         if(event.keyCode!=8){
	     var realkey = String.fromCharCode(event.keyCode);
	         match(realkey);
		     return false;
	         }
	         
	     }
	 }

	/**find the match string*/
	function match(str){
	     //alert(document.getElementById('textarea2').value);
	     var temp =document.getElementById('search_info').value;
	     
	     
	     var cprStr=temp+str;

	     show=[];
	     len=0;
	     for (i in class_hierachy){
	     	if(cprStr==class_hierachy[i][0].substring(0,cprStr.length)){
	    	    len=show.push(class_hierachy[i][0]);
	        }
	     } 
	     //alert("Have "+len+" compatible records");
	 var div1=document.getElementById('show');
	     div1.innerHTML="";
	     htmlStr=""
	     for (i in show){
		 	htmlStr+="<a style=\"cursor: pointer;\" onclick=\"choose(this)\">"
	        htmlStr+=show[i];
			htmlStr+="</a>"
	        htmlStr+="</br>";
	     }
	 div1.innerHTML+=htmlStr;
	 }

	/**when you select a matched string, it clears the div of the list of matches, and selects in the tree the selected, node that matched the string.*/
	function choose(str){
		var temp=str.childNodes[0].nodeValue;
		//puts the selected term from the search into the search box
		document.getElementById('search_info').value=temp;
		//clears the show div
		document.getElementById('show').innerHTML="";
		//this does not change selection, you still need to hit search, so the method for that is handled in the .jsp file where search_node is called.
	}

	/*find where this node is*/
	function search_node(){
		 var temp =document.getElementById('search_info').value;
		 var flag=0;
		 for (var i=0;i<class_hierachy.length;i++){
		 	if(temp==class_hierachy[i][0]){
				flag=1;
				if(document.all){
					//this selects the matched node with the label
					document.getElementById(i).firstChild.click();
				}
				else{
					var evt = document.createEvent("MouseEvents");  
		 				evt.initEvent("click", true, true);  
				  	    document.getElementById(i).childNodes[1].dispatchEvent(evt);  
				}
				//alert(" found !");
				break;
			}
		 }
		 if(flag==0){
		 	alert(" not found !")
		 }
		 document.getElementById('search_info').value="";
		 document.getElementById('show').innerHTML="";
	}

	</script>
	
	<script>
	$(function() {
    $("#DataTypeTree").jstree({
    	
    	"themes" : {
				 "theme" : "apple",
				 "dots"  : true,
				 "icons" : true,
	 	         "url": "../../js/jstree/themes/apple/style.css"
			},
    	
        "json_data": {
            "data": [
                {
                    "attr": { "id": "" },
                    "data": "[ Data Types ]",
                    "state": "open",
                    "children": [
                        {
                            "data": "xsd:string"
                        },
                        {
                            "data": "xsd:boolean"
                        },
                        {
                            "data": "xsd:decimal"
                        },
                        {
                            "data": "xsd:float"
                        },
                        {
                            "data": "xsd:double"
                        },
                        {
                            "data": "xsd:integer"
                        },
                        {
                            "data": "xsd:anyURI"
                        }
                    ]
                }
            ]
        },
        
        "crrm" : {
            "move" : {
                "check_move" : function (data) {
                    //alert(data.r.attr("id"));
                    if(data.r.attr("id") == "") {
                        
                    }
                }
            }
        },
        
        "plugins": ["themes", "json_data", "ui", "dnd", "crrm"]
    });
});
	</script>
	
	<script>
	 var jsonHier_prop;
	 var class_hierachy_prop=new Array();

	 var class_hierachy_prop_temp=new Array();

	 
	 $(function() {
		  AnnotatorModule.queryForAnnotatorRootObjectProperties({}, function (data){
							
	        	    		  jsonHier_prop=JSON.parse(data);
	        	    		  jsonHier_prop=jsonHier_prop["data"];
	        	    		  initial_hierachy_prop();
	        	    		  
	        	    		          	    		  
	        	       }
	        	       );
	        	});
	 


	 var show_prop=new Array();
	 var len_prop=0;

	 
	function initial_hierachy_prop(){
		//alert(jsonHier_ch);
		//alert("aaa");
		var flag=0;
		for (var i=0;i<jsonHier_prop.length;i++){
			flag=0;
			for (var j=0;j<jsonHier_prop.length;j++){
				
				if(jsonHier_prop[i]["parent"]==jsonHier_prop[j]["id"]){
					//alert(jsonHier_ch[i]);
					flag=1;
					break;
				}
			}
			if(flag==0){
				var flag1=0
				for (var k=0;k<class_hierachy_prop_temp.length;k++){
					if(class_hierachy_prop_temp[k][2]==jsonHier_prop[i]["parent"]){
						flag1=1;
						break;
					}
			
				}
				if(flag1==0){
					var temp1=jsonHier_prop[i]["parent"].indexOf("#");
					class_hierachy_prop_temp.push(new Array(jsonHier_prop[i]["parent"].substring(temp1+1),null,jsonHier_prop[i]["parent"]));
					class_hierachy_prop.push(new Array(jsonHier_prop[i]["parent"].substring(temp1+1),null,jsonHier_prop[i]["parent"]));
					//jsonHier_prop.remove(i);
				}
			}
		}
		
		
		for (var j=0;j<class_hierachy_prop_temp.length;j++){
			 for (var i=0;i<jsonHier_prop.length;i++){
				 		 	
					if(jsonHier_prop[i]["parent"]==class_hierachy_prop_temp[j][2]){
						class_hierachy_prop.push(new Array(jsonHier_prop[i]["label"],jsonHier_prop[i]["parent"],jsonHier_prop[i]["id"]));
						
						//jsonHier.remove(i);
					}
			 }
			
		}
		
		
		var temp_div=document.getElementById('PropertyTree');
		temp_div.innerHTML="";
		
		for (var i=0;i<class_hierachy_prop_temp.length;i++){
			var ul=document.createElement("ul");
			var li=document.createElement("li");
			var a=document.createElement("a");
			a.href="#";
			var text=document.createTextNode(class_hierachy_prop_temp[i][0]);
			var temp_root=i+"_prop";
			li.id=temp_root;
			a.appendChild(text); 
			li.appendChild(a); 
			ul.appendChild(li); 
			temp_div.appendChild(ul); 
			document.getElementById('description_prop').appendChild(temp_div);
			    //alert("success");
			
			var j;
		    for ( j=class_hierachy_prop_temp.length;j<class_hierachy_prop.length;j++){ 
				append_node_prop(j,temp_root);
			}
		    
		}
		
		
		$(function () {
			$("#PropertyTree")
				.jstree({
					"themes" : {
	   					 "theme" : "classic",
	   					 "dots" : true,
	  					 "icons" : true,
	  		 	         "url": "../../js/jstree/themes/classic/style.css"

					},
					 "core" : { "initially_open" : [ "0_prop" ] },
					 
					 "dnd" : {
	   		                "drop_target" : "#list th",
	   		                "drop_finish" : function (data) {
	   		                	$(data.r).css("background-color","#00ff00");
	                         //add the node name to the header, and get the parent node "id"
	   		                 var p = data.o.attr("id");
	   		                 //alert(p);

	   		                 var q = $(data.o).text();
	   		                 //alert(q);
	   		                 
	   		                 var i = data.r.attr("id");
	   		                 //alert(i);
	   		                 
	   		                 var r = $(data.r).text();
	   		                 //alert(r);
	   		                 
	   		                 var cn = i.split(',')[1];
	   		                 
	   		                 if (window.propertyRow ==1){
	   		                 $("[id='propertyRow,"+cn+"']").text(q.replace(/^\s+|\s+$/g,''));   		                	 
	   		                 }
	   		              
	   		                 else
	   		                 {
	   		                 var tr = "<tr id='propertyRow'>";
	   		                 for (var j = 0; j < window.column_numbers; ++j) {
	   		                	 tr+="<td id='propertyRow,"+j+"'>";
	   		                	 if (j == cn) tr += q.replace(/^\s+|\s+$/g,'');
	   		                	 tr += "</td>";
	   		                 }
	   		                 tr+= "</tr>";
	   		                 $('#list tr:first').after(tr);
	   		                 window.propertyRow = 1;
	   		                 }
	   		                 
	   		             //  window.annotationMappings = {"RangeClass":[{"classname":"url"}], "Property":[{"propertyname": "url"}]};
	   		                 
	   		            function keySearch(dict,key) {
   		            	for (var i in dict) if (key in dict[i]) 
   		            		return dict[i][key];
   		            	return null;                            		            
   		                }
   		            
   		            
   		            var am = window.a;
   		            var kg = keySearch(am,r);
   		            var args = {};
		            args[r]  = {"Property":p};
   		           
   		            if (kg!=null){   		            	
   		            	kg["Property"] = p;   		            
   		            }            
			        else{
				        am.push(args);
			        };
	/*                         
	   		                 for (i in annotationMappings) {
	   		            	 for (j in annotationMappings[i][0]) {
	   		            	 alert(j+":"+annotationMappings[i][0][j]);
	   		            	 }
	   		            	 }
	   		 
	   		              
	   		                 for (i in annotationMappings) {
	   		            	 if ($.isArray(annotationMappings[i])) {
	   		            	 alert(i + ": " + "Array["+annotationMappings[i].length+"]<br />");
	   		            	 } else {
	   		            	 alert(i + ": Object<br />");
	   		            	 }
	   		            	 }	            	  
	*/   		                
	   		                }
	   		            },
	   		            
	   		            "crrm" : { move : { check_move : function (m) { return false; } } },
					 
					 "plugins" : ["themes","html_data","ui","dnd", "crrm"] })
						// 1) if using the UI plugin bind to select_node
		
						.bind("select_node.jstree", function (event, data) { 
						// `data.rslt.obj` is the jquery extended node that was clicked
							 var temp=data.rslt.obj.attr("id");
								//alert(class_hierachy[temp][0]);
								//alert(class_hierachy[temp][1]);
							  var index=temp.indexOf("_");
							  temp=temp.substring(0,index);
							  //alert(temp);
							  $.bbq.pushState({"queryForAnnotatorSubObjectProperties":class_hierachy_prop[temp][2]});
						      ajax_node_prop();
							  getSelectedValue_prop();
					})
					    
					
					
						// 2) if not using the UI plugin - the Anchor tags work as expected
						//    so if the anchor has a HREF attirbute - the page will be changed
				//    you can actually prevent the default, etc (normal jquery usage)
						.delegate("a", "click", function (event, data) { event.preventDefault(); })
		});

	}

	function getSelectedValue_prop() {  
	    var nodes = $.jstree._reference($("#PropertyTree")).get_selected();
	    var temp=new Array();
	    $.each(nodes, function(i, n) {  
	    	
	    	for (var i=0;i< nodes.length;i++){
	    		var temp_id=this.id;
	    		var index=temp_id.indexOf("_");
	   	     	var temp_id1=parseInt(temp_id.substring(0,index));
	   	     	var temp_id2=nodes[i].id;
	   	        index=temp_id2.indexOf("_");
		        var temp_id3=parseInt(temp_id2.substring(0,index));
	    		if(class_hierachy_prop[temp_id1][1]==class_hierachy_prop[temp_id3][2]){
	    			$.jstree._reference($("#PropertyTree")).deselect_node(nodes[i]);
	    			//alert(nodes[i].id);
	    			break;
	    		}
	    		
	    	};
	    
	    }); 
	    
	    nodes = $.jstree._reference($("#PropertyTree")).get_selected();
	    $.each(nodes, function(i, n) {  
	    	 var temp_id=this.id;
	    	 var index=temp_id.indexOf("_");
		     var temp_id1=parseInt(temp_id.substring(0,index));
	         temp.push(class_hierachy_prop[temp_id1][2]);
	         
	    }); 
	    $.bbq.pushState({"property":temp});
	}  


	function append_node_prop(current, parent){
		var temp_judge=parent;
		var index=temp_judge.indexOf("_");
		temp_judge=parseInt(temp_judge.substring(0,index));
	    if(class_hierachy_prop[current][1]==class_hierachy_prop[temp_judge][2]){
			var temp_div=document.getElementById(parent);
			var ul=document.createElement("ul");
			var li=document.createElement("li");
			var a=document.createElement("a");
			a.href="#";
			var text=document.createTextNode(class_hierachy_prop[current][0]);
			var temp_id=current.toString()+"_prop";
			//cannot use id variable because id is used by species, and the li needs to be distinct, so we have 0 for species and we have 0_ch for charactatericcs.
			li.id=temp_id;
			a.appendChild(text); 
			li.appendChild(a); 
			ul.appendChild(li); 
			temp_div.appendChild(ul); 
		 	    //alert("success");
			
		}
	}	


	function ajax_node_prop() {
		AnnotatorModule.queryForAnnotatorSubObjectProperties({}, function(data) {
			jsonHier_prop = JSON.parse(data);
			jsonHier_prop = jsonHier_prop["data"];
			var flag=0;
			var id=0;
			if (jsonHier_prop.length == 0) {
				//alert("null");
			} else {
				for ( var parent = 0; parent < class_hierachy_prop.length; parent++) {
					if (jsonHier_prop[0]["id"] == class_hierachy_prop[parent][2]) {
						flag = 1;
						break;
					}
				}
				if (flag == 1) {
					//alert("error");
				} else {
					//alert("success");
					for ( var i = 0; i < jsonHier_prop.length; i++) {
						for ( var parent = 0; parent < class_hierachy_prop.length; parent++) {
							
							if (jsonHier_prop[i]["parent"] == class_hierachy_prop[parent][2]) {
								id=parent;
								parent=parent+"_prop";
								var temp_div = document.getElementById(parent);
								var ul = document.createElement("ul");
								var li = document.createElement("li");
								var a = document.createElement("a");
								a.href = "#";
								var text = document.createTextNode(jsonHier_prop[i]["label"]);
								li.id = class_hierachy_prop.length+"_prop";
								a.appendChild(text);
								li.appendChild(a);
								ul.appendChild(li);
								temp_div.appendChild(ul);
								// alert("success");
								class_hierachy_prop.push(new Array(jsonHier_prop[i]["label"],jsonHier_prop[i]["parent"],jsonHier_prop[i]["id"]));
								break;
							}
						}
					}
					var tree = jQuery.jstree._reference("#" + id+"_prop");
			        tree.refresh();
			        document.getElementById(id+"_prop").firstChild.click();
				}
			}
			
		});
	}

	document.onkeydown = keyDown_prop;

	function keyDown_prop(){
	     if(event.keyCode==8){
	     	var temp =document.getElementById('search_info_prop').value;
	     
	    	var cprStr=temp;
	     	if(cprStr.length!=1&&cprStr.length!=0){             
	     		cprStr=cprStr.substring(0,cprStr.length-1);
	     
	    		show_prop=[];
	    		len_prop=0;
	    		for (i in class_hierachy_prop){
	     			if(cprStr==class_hierachy_prop[i][0].substring(0,cprStr.length)){
	    	    		len_prop=show.push(class_hierachy_prop[i][0]);
	        		}
	     		} 
	    	 }
	 	 else{
	 	show_prop=[]
	         }
	    	 //alert("Have "+len+" compatible records");
		  var div1=document.getElementById('show_prop');
	   	  div1.innerHTML="";
	   	  htmlStr=""
	   	  for (i in show_prop){
	      	  htmlStr+="<a style=\"cursor: pointer;\" onclick=\"choose_prop(this)\">"
	       	  htmlStr+=show_prop[i];
			  htmlStr+="</a>"
	          htmlStr+="</br>";
	     }
		  div1.innerHTML+=htmlStr;
	    	  //alert(show);
	     }
	     
	 }


	function press_prop(event){
	 var e=event.srcElement;
	     if(event.keyCode!=13){
	         if(event.keyCode!=8){
	     var realkey = String.fromCharCode(event.keyCode);
	         match_prop(realkey);
		     return false;
	         }
	         
	     }
	 }

	function match_prop(str){
	     //alert(document.getElementById('textarea2').value);
	     var temp =document.getElementById('search_info').value;
	     
	     
	     var cprStr=temp+str;

	     show_prop=[];
	     len_prop=0;
	     for (i in class_hierachy_prop){
	     	if(cprStr==class_hierachy_prop[i][0].substring(0,cprStr.length)){
	    	    len_prop=show_prop.push(class_hierachy_prop[i][0]);
	        }
	     } 
	     //alert("Have "+len+" compatible records");
	 var div1=document.getElementById('show_prop');
	     div1.innerHTML="";
	     htmlStr=""
	     for (i in show_prop){
		 	htmlStr+="<a style=\"cursor: pointer;\" onclick=\"choose_prop(this)\">"
	        htmlStr+=show_prop[i];
			htmlStr+="</a>"
	        htmlStr+="</br>";
	     }
	 div1.innerHTML+=htmlStr;
	 }
	function choose_prop(str){
		var temp=str.childNodes[0].nodeValue;
		document.getElementById('search_info_prop').value=temp;
		document.getElementById('show_prop').innerHTML="";
	}

	function search_node_prop(){
		 var temp =document.getElementById('search_info_prop').value;
		 var flag=0;
		 for (var i=0;i<class_hierachy_prop.length;i++){
		 	if(temp==class_hierachy_prop[i][0]){
				flag=1;
				if(document.all){
					document.getElementById(i).firstChild.click();
				}
				else{
					var evt = document.createEvent("MouseEvents");  
		 				evt.initEvent("click", true, true);  
				  	    document.getElementById(i).childNodes[1].dispatchEvent(evt);  
				}
				//alert(" found !");
				break;
			}
		 }
		 if(flag==0){
		 	alert(" not found !")
		 }
		 document.getElementById('search_info_prop').value="";
		 document.getElementById('show_prop').innerHTML="";
	}

	</script>

	<script>
/*	$(function() {
		$.get('test.csv', function(data) {
			$('#CSVSource').html('<pre>' + data + '</pre>');
		});
		$('#CSVTable').CSVToTable('test.csv', { loadingImage: 'images/loading.gif', startLine: 0 });
		$.get('test.csv', function(data) {
			$('#TSVSource').html('<pre>' + data + '</pre>');
		});
		$('#TSVTable').CSVToTable('test.csv', { loadingText: 'Loading TSV Data...', loadingImage: 'images/loading.gif', startLine: 0, separator: "\t" });
		$('#CSVTable2').CSVToTable('test.csv', { loadingImage: 'images/loading.gif', startLine: 0 }).bind("loadComplete",function() { 
			$('#CSVTable2').find('TABLE').tablesorter();
		});;
	}); 
*/	</script>

<script>
$(document).ready(function(){
	$(window).trigger("initialize");
  });
</script>

</head>
<body onload="">
  <div id="wrap" style="float:left;width:70%;">
    <h1>Please select a csv file</h1>
    <form action="javascript:void(0);" id="the_form">
      <input type="file" id="the_file" required="required" accept=".csv"/>
      <input type="submit" id="initial_button" value="Go" class="btn"/>
    </form>
  <div id="file_info"></div>
  </div>
  <div style="margin-left:70%; width:30%;">
  <div id="source_info"  ><textarea id="source_box" style=" overflow:hidden;padding:0 ;width:100%;height:100%;border:1;" placeholder="Type source here!" onKeyPress="press(event)"></textarea></div>
  <div id="dataset_info" ><textarea id="dataset_box" style=" overflow:hidden;padding:0 ;width:100%;height:100%;border:1;" placeholder="Type dataset here!" onKeyPress="press(event)"></textarea></div>
  </div>

<div style="float:left;width:70%;">

  <div id="list" style="overflow:scroll; height:1000px; margin-right:6px;"></div>

  <script type="text/javascript">

  function fileInfo(e){
    var file = e.target.files[0];
    if (file.name.split(".")[1].toUpperCase() != "CSV"){
      alert('Invalid csv file !');
      e.target.parentNode.reset();
      return;
    }else{
      document.getElementById('file_info').innerHTML = "<p>File Name: "+file.name + " | "+file.size+" Bytes.</p>";
    }
  }
  
 //csv file parser and table loader
 function handleFileSelect(){
  if (window.hasTable == 1) return; 
  var file = document.getElementById("the_file").files[0];
  var reader = new FileReader();
  var link_reg = /(http:\/\/|https:\/\/)/i;
  reader.onload = function(file) {
              var content = file.target.result;
              var rows = file.target.result.split(/[\r\n|\n]+/);
              var table = document.createElement('table');
              
              for (var i = 0; i < rows.length; i++){
                var tr = document.createElement('tr');
                var arr = rows[i].split(',');
				var td;
                for (var j = 0; j < arr.length; j++){
                  if (i==0) {
                    td = document.createElement('th');
                    $(td).attr("id", i+','+j); 
                  }
                  else {
                    td = document.createElement('td');
                    $(td).attr("id", i+','+j);
                  }
                  if( link_reg.test(arr[j]) ){
                    var a = document.createElement('a');
                    a.href = arr[j];
                    a.target = "_blank";
                    a.innerHTML = arr[j];
                    td.appendChild(a);
                  }else{
                    td.innerHTML = arr[j];
                  }
                  tr.appendChild(td);
                }

                table.appendChild(tr);
              }

              document.getElementById('list').appendChild(table);
              window.file_contents = file.target.result;
              alert(window.file_contents);
              window.column_numbers = rows[0].split(',').length;
              window.hasTable = 1;
            // annotationMappings initialization  
              window.a = [];
            // window.a.push({"annotationMappings":[{"initialization":"0"}]});
            // send the csv file to the server
              AnnotatorModule.readCsvFileForInitialConversion({"csvFile":window.file_contents},
            		  function(d) { console.log(d); });
          };
  reader.readAsText(file);
  
 }
 document.getElementById('the_form').addEventListener('submit', handleFileSelect, false);
 document.getElementById('the_file').addEventListener('change', fileInfo, false);
</script>	
<div><br><button id="commit_enhancement" style="padding: 10px;">Commit Enhancement</button></div>
<script type="text/javascript">
        $(document).ready(function() {
        $('#commit_enhancement').click(function() {
        	$.bbq.pushState({"annotationMappings": window.a});
        	AnnotatorModule.queryForEnhancing({},
        			function(d) { console.log(d); });
        })});
</script>
</div>
<div style="margin-left:70%; width:30%;">
<div>

 <table cellpadding="0"; cellspacing="0">
      <tr>
	    <td colspan="2">
		   
		</td>
	  </tr>
	 <tr>
          <td  ><div id="text"  ><textarea name ="search" id="search_info" style=" overflow:hidden;padding:0 ;width:100%;height:100%;border:1;" placeholder="Type message here!" onKeyPress="press(event)"></textarea></div>
		  <td style=" width:20%;"><input type=button onClick=" search_node()" value="search"/></td>
		  </td>         
      
     </tr>
	 <tr>
          <td colspan="2">       
           <div id="description" style="  border:1px solid #111111; overFlow: auto; " >
			<div id="tree" class="demo" style="width:120%;height:500px;">

			</div>

			</div>
		  </td>
     </tr>
     <tr>
          <td  ><div id="text_prop"  ><textarea name ="search" id="search_info_prop" style=" overflow:hidden;padding:0 ;width:100%;height:100%;border:1;" placeholder="Type message here!" onKeyPress="press_prop(event)"></textarea></div>
		  <td style=" width:20%;"><input type=button onClick=" search_node_prop()" value="search"/></td>
		  </td>         
      
     </tr>
          <tr>
          <td colspan="2">       
           <div id="description_prop" style="  border:1px solid #111111; overFlow: auto; " >
			<div id="PropertyTree" class="demo3" style="width:120%;height:300px;">

			</div>

			</div>
		  </td>
     </tr>
     
     <tr>
          <td colspan="2">       
           <div id="description2" style="  border:1px solid #111111; overFlow: auto; " >
			<div id="DataTypeTree" class="demo2" style="width:120%;height:150px;">

			</div>

			</div>
		  </td>
     </tr>
	
    </table>

</div>
</div>
<div style="clear:both"></div>


</body>
</html>