package edu.rpi.tw.escience.dataone;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.List;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.hp.hpl.jena.ontology.OntModel;
import com.hp.hpl.jena.rdf.model.Model;

import edu.rpi.tw.escience.semanteco.Domain;
import edu.rpi.tw.escience.semanteco.Module;
import edu.rpi.tw.escience.semanteco.ModuleConfiguration;
import edu.rpi.tw.escience.semanteco.QueryMethod;
import edu.rpi.tw.escience.semanteco.Request;
import edu.rpi.tw.escience.semanteco.Resource;
import edu.rpi.tw.escience.semanteco.SemantEcoUI;
import edu.rpi.tw.escience.semanteco.query.Query;

public class DataoneSolrModule implements Module {


	public static void main (String[] args) throws JSONException{
		//queryTopic("birds");
	}
	//
	private ModuleConfiguration config = null;

	@Override
	public void visit(final Model model, final Request request, final Domain domain) {
		// TODO populate data model
	}

	@Override
	public void visit(final OntModel model, final Request request, final Domain domain) {
		// TODO populate ontology model
	}

	@Override
	public void visit(final Query query, final Request request) {
		// TODO modify queries
	}

	@Override
	public void visit(final SemantEcoUI ui, final Request request) {
		// TODO add resources to display
		ui.addScript(config.getResource("dataone.js"));
		ui.addScript(config.getResource("vocab.js"));
	}

	@Override
	public String getName() {
		return "DataoneSolr";
	}

	@Override
	public int getMajorVersion() {
		return 1;
	}

	@Override
	public int getMinorVersion() {
		return 0;
	}

	@Override
	public String getExtraVersion() {
		return null;
	}

	@Override
	public void setModuleConfiguration(final ModuleConfiguration config) {
		this.config = config;
	}

	@QueryMethod
	public String testMethodAwesome(final Request request) {
		System.out.println("test awesome");
		return null;
	}

	@QueryMethod
	public JSONArray expandOnSearchTerm(final Request request) throws JSONException{
		JSONArray searchTermTopicExpanded = new JSONArray();
		JSONArray searchType = (JSONArray) request.getParam("searchType");
		String searchTerm = request.getParam("term").toString();

		for(int i = 0; i< searchType.length(); i++){
			System.out.println("a searchType: " + searchType.get(i));

			if(searchType.get(i).toString().equals("topic")){
				System.out.println("(doing topic search now) "); 
				//searchTermTopicExpanded = expandTopicJSON(searchTerm);
			}	
		}
		return searchTermTopicExpanded;		
	}

	@QueryMethod
	public String outputExpansionSelections(final Request request) throws JSONException{	
		JSONArray expansion = (JSONArray) request.getParam("expansionTerm");
		System.out.println("expansion: " + expansion.toString());
		return null;
	}
	
	@QueryMethod
	public String performSearch(final Request request) throws JSONException{
		JSONObject serviceResults = null;
		JSONArray expansion = (JSONArray) request.getParam("expansionTerm");
		System.out.println("expansion: " + expansion.toString());
		serviceResults =  searchSolr(Orify(expansion));
		return serviceResults.toString();
	}

	@QueryMethod
	public String accessService(final Request request) throws JSONException{	
		//query = "http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion.php?q=insect%20herbivore";
		//WebServiceRequestHandler.getRequest(query, "text");		
		//query = "http://data1.tw.rpi.edu/tomcat/VocabularyServer/ServeSparql?term=passeriformes&Submit=Submit&domain=organism&getTree=true&upward=true&level=1";			
		//WebServiceRequestHandler.getRequest(query, "text");

		JSONArray expansion = (JSONArray) request.getParam("expansionTerm");
		System.out.println("expansion: " + expansion.toString());
		
		JSONObject objVocab = null;
		JSONObject objTopic = null;
		JSONArray domains = null;
		String searchTerm = request.getParam("term").toString();
		System.out.println("searched term is : " + searchTerm);
		System.out.println("request object is : " + request.toString());


		/*
		if(request.getParam("domain") != null){
			domains = (JSONArray) request.getParam("domain");
			for(int i = 0; i< domains.length(); i++){
				System.out.println("a domain: " + domains.get(i));
			}	
		}
		*/

		JSONArray searchType = (JSONArray) request.getParam("searchType");
		for(int i = 0; i< searchType.length(); i++){
			System.out.println("a searchType: " + searchType.get(i));
			if(searchType.get(i).toString().equals("vocabulary")){
				System.out.println("(doing vocab search first) "); 

				String searchTermVocabExpanded = expandConcept(searchTerm, domains);
				objVocab = searchSolr(searchTermVocabExpanded);
			}
			if(searchType.get(i).toString().equals("topic")){
				System.out.println("(doing topic search now) "); 
				String searchTermTopicExpanded = expandTopic(searchTerm);
				objTopic =  searchSolr(searchTermTopicExpanded);
			}	
		}
		//query = "https://cn-orc-1.dataone.org/cn/v1/query/solr/?q=abstract:ecology+OR+hydrology&wt=json&rows=100";
		//query = "https://cn-orc-1.dataone.org/cn/v1/query/solr/?q=abstract:ecology+AND+hydrology&wt=json&rows=10000000";

		//JSONObject j = getRequest(query, "json");
		//coll = new DataoneDataObjectCollection(j, query, false);
		//keywords = coll.getKeywords();

		//JSONObject results = j.getJSONObject("response");
		//JSONArray tempDataoneArray = (JSONArray) results.get("docs");
		//System.out.println("Document1 count is: " + tempDataoneArray.length());

		//query = "https://cn-orc-1.dataone.org/cn/v1/query/solr/?q=abstract:hydrology&wt=json&rows=100";

		//System.out.println("objVocab: " + objVocab.toString()); 
		//System.out.println("objTopic: " + objTopic.toString()); 

		JSONArray inVocabNotTopic = getDiff(objVocab, objTopic);
		JSONArray inTopicNotVocab = getDiff(objTopic, objVocab);

		//diff id output
		for(int i = 0 ; i < inVocabNotTopic.length(); i++){
			System.out.println("inVocabNotTopic: " + inVocabNotTopic.get(i).toString());
		}
		System.out.println("inVocabNotTopic diff id count:" + inVocabNotTopic.length());
		//String searchTermTopicExpanded = expandConcept(searchTerm);
		return objVocab.toString();
	}

	public static JSONObject searchSolr(String searchTerm) throws JSONException{

		String query = "https://cn-orc-1.dataone.org/cn/v1/query/solr/?q=abstract:" + searchTerm + "&wt=json&rows=20";
		System.out.println("query is : " + query);
		JSONObject j2 = (JSONObject) getRequest(query, "json");		
		//System.out.println("Document count is: " +  DataoneDataObjectCollection.getDataOneJsonFromResponse(j).length());
		//DataoneDataObject d;	
		System.out.println("(query has been made)");	
		System.out.println("j2 in searchSolr: " + j2.toString());

		JSONObject  results = j2.getJSONObject("response");
		//System.out.println("response: " + results);
		//System.out.println("j2: " + j2.toString());

		JSONArray  tempDataoneArray = (JSONArray) results.get("docs");	
		System.out.println("Document2 count is: " + tempDataoneArray.length());		
		System.out.println("searched term is : " + searchTerm);
		System.out.println("query is : " + query);
		return j2;

	}

	public static String expandConcept(String searchTerm, JSONArray domains) throws JSONException{
		//http://data1.tw.rpi.edu/tomcat/VocabularyServer/ServeSparql?term=passeriformes&Submit=Submit&domain=organism&getTree=true&upward=true&level=1	
		String query = "http://data1.tw.rpi.edu/tomcat/VocabularyServer/ServeSparql?term=" + searchTerm + "&Submit=Submit" ;
		if(domains != null){
			query += "&domain=organism";
		}
		query += "&getTree=true&upward=true&level=1";

		System.out.println("query is : " + query);
		JSONObject j2 = (JSONObject) getRequest(query, "json");	
		System.out.println("j2 is : " + j2.toString());
		String preferredLabel = j2.get("preferredLabel").toString();
		searchTerm = searchTerm + "+OR+" + "'" + preferredLabel + "'";
		return searchTerm;
	}



	@QueryMethod
	public static String expandConceptJSON(final Request request) throws JSONException{
		JSONArray expansions = new JSONArray();
		JSONArray domains = null;
		String depth = "";
		String searchTerm = request.getParam("term").toString();
		System.out.println("searched term is : " + searchTerm);
		System.out.println("request object is : " + request.toString());


		if(request.getParam("domain") != null){
			domains = (JSONArray) request.getParam("domain");
			for(int i = 0; i< domains.length(); i++){
				System.out.println("a domain: " + domains.get(i));
			}	
		}  
		
		if(request.getParam("depth") != null){
			depth = request.getParam("depth").toString();
		}   

		//example
		//http://data1.tw.rpi.edu/tomcat/VocabularyServer/ServeSparql?term=passeriformes&Submit=Submit&domain=organism&getTree=true&upward=true&level=1	
		String query = "http://data1.tw.rpi.edu/tomcat/VocabularyServer/ServeSparql?term=" + searchTerm + "&Submit=Submit" ;
		if(domains != null){
			query += "&domain=" + domains.get(0).toString();
		}
		
		if(depth != ""){
			query += "&getTree=true&upward=true&level=" + depth;
		}
		else{ //default at 3 levels for now
		query += "&getTree=true&upward=true&level=3";
		}

		System.out.println("query is : " + query);
		JSONObject j2 = (JSONObject) getRequest(query, "json");	
		
		//here we're just retrieving the first level of (example output):
		//j2 is : {"preferredLabel":"nitrite","synonyms":["amyl nitrite"],
		//"hypernyms":[{"preferredLabel":"nitrogen oxide","synonyms":["nitrogen dioxide radical"]},{"preferredLabel":"oxide","synonyms":[]},{"preferredLabel":"oxygen compound","synonyms":[]},{"preferredLabel":"nitrogen compound","synonyms":["imidoester"]},{"preferredLabel":"chemical","synonyms":[]}]}
		
		//rewrite this to not use data1.tw service but bioportal directly?
		//you can do the xml parsing like Zach did (which he did in python) or 
		//you can use the code available in the bioportal appliance that you've used. (which *is* that service
				
		System.out.println("\n" + "vocab query results are : " + j2.toString() + "\n");
		String preferredLabel = j2.get("preferredLabel").toString();
		
		//handle leaf term (i.e., matched term) level synonyms
		if( j2.get("synonyms") != null){		
			JSONArray leafSynonyms = (JSONArray) j2.get("synonyms");
			   for(int j=0; j < leafSynonyms.length(); j++){
					String syn = (String) leafSynonyms.get(j);
					if(!isStringInArray(syn, expansions)){
						expansions.put(syn);						
					}
			   }	
		}

		
		JSONArray hypernymObject = (JSONArray) j2.get("hypernyms");
		System.out.println("hypernyms jsonArray is : " +  hypernymObject.toString());
		
		for(int i=0; i < hypernymObject.length(); i++){
			JSONObject obj = (JSONObject) hypernymObject.get(i);
			System.out.println("hypernym entry is : " +  obj.toString());

			String label = obj.get("preferredLabel").toString();
			System.out.println("\n" + "hypernym entry preferred term is : " +  label + "\n");

			if(!isStringInArray(label, expansions)){
			expansions.put(label);
			}
			
			//also add the synonyms for the hypernym terms.
			if( obj.get("synonyms") != null){
			JSONArray synonyms = (JSONArray) obj.get("synonyms");
			   for(int j=0; j < synonyms.length(); j++){
					String syn = (String) synonyms.get(j);
					if(!isStringInArray(syn, expansions)){
						expansions.put(syn);						
					}
			   }
			}	
		}
		
		//String synonymLabel = j2.get("synonyms").toString();

		
		//searchTerm = searchTerm + "+OR+" + "'" + preferredLabel + "'";
		
		if(!isStringInArray(preferredLabel, expansions)){
			expansions.put(preferredLabel);
			
		}
		if(!isStringInArray(searchTerm, expansions)){
		expansions.put(searchTerm);
		}
		
		return expansions.toString();
	}
	
	public static boolean isStringInArray(String string, JSONArray jsonArray) throws JSONException{
		for(int i=0; i < jsonArray.length(); i++){
			if(string.toLowerCase().equals(jsonArray.get(i).toString().toLowerCase())){
				return true;
			}
		}
		
		return false;
		
	}
	
	public static String Orify(JSONArray termList) throws JSONException{
		String search = "";
		String search2 = "";
		for(int i = 0; i< termList.length(); i++){
			//System.out.println("j2: " + temp[2].toString());	
			if(!search.equals("") ){
				search += "+OR+";
			}
			//replace blanks in the string with '+'.
			String term = termList.get(i).toString().replace(" ","+");

			
			
			search += term;
		}
		System.out.println("final search: " + search);
		return search;
		
	}

	/**
	 * from the search term, return the EES corpora trained topic that term appears in
	 * calls Ben Adam's service at nceas and parses it into a solr string using disjunction
	 * @param searchTerm
	 * @return
	 * @throws JSONException
	 */
	public static String expandTopic(String searchTerm) throws JSONException{
		// http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion_ees.php?q=
		String query = "http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion_ees.php?q=" + searchTerm;
		System.out.println("query is : " + query);
		String j2 = (String) getRequest(query, "text");	
		System.out.println("j2 is : " + j2);
		String[] temp = new String[100];
		String[] temp3 = new String[100];

		temp = j2.split("\t");
		//String[] temp2 = new String[100];
		String temp2 = temp[2].toString();
		temp3 = temp2.split(" ");

		System.out.println("index 0: " + temp[0].toString());		
		System.out.println("1: " + temp[1].toString());
		System.out.println("2: " + temp[2].toString());
		System.out.println("temp3: " + temp3.toString());


		//iterate on the one forward for OR string
		String search = "";
		String search2 = "";
		for(int i = 2; i< temp3.length; i++){
			//System.out.println("j2: " + temp[2].toString());	
			if(!search.equals("") ){
				search += "+OR+";
			}
			search2 = temp3[i].replace("<br/>","");
			search +=  search2;
			//System.out.println("search: " + search);
			//System.out.println("search2: " + search2);

		}
		//JSONObject  results = j2.getJSONObject("response");	

		System.out.println("final search: " + search);
		return search;
	}

	/**
	 * from the search term, return the EES corpora trained topic that term appears in
	 * calls Ben Adam's service at nceas and parses it into a solr string using disjunction
	 * @param searchTerm
	 * @return
	 * @throws JSONException
	 */
	@QueryMethod
	public static String expandTopicJSON(final Request request) throws JSONException{
		JSONArray expansions = new JSONArray();
		String query = "";
		String searchTerm = request.getParam("term").toString();
		System.out.println("search term is: " + searchTerm);
		if(request.getParam("term") != null){
			query = "http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion_ees.php?q=" + searchTerm;
		}
		else{
			return null;
		}

		//take the search Term

		// http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion_ees.php?q=
		System.out.println("query is : " + query);
		String j2 = (String) getRequest(query, "text");	
		System.out.println("j2 is : " + j2);
		String[] temp = new String[100];
		String[] temp3 = new String[100];

		temp = j2.split("\t");
		String temp2 = temp[2].toString();
		temp3 = temp2.split(" ");
		System.out.println("index 0: " + temp[0].toString());		
		System.out.println("1: " + temp[1].toString());
		System.out.println("2: " + temp[2].toString());
		System.out.println("temp3: " + temp3.toString());
		String search = "";
		String search2 = "";
		for(int i = 2; i< temp3.length; i++){

			search2 = temp3[i].replace("<br/>","");
			expansions.put(search2);

		}
		System.out.println("final search: " + expansions.toString());
		return expansions.toString();
	}

	/**
	 * from the search term, return the EES corpora trained topic that term appears in
	 * calls Ben Adam's service at nceas and parses it into a solr string using disjunction
	 * @param searchTerm
	 * @return
	 * @throws JSONException
	 */
	@QueryMethod
	public static String expandTopicJSONPassteriformes(final Request request) throws JSONException{
		JSONArray expansions = new JSONArray();
		// http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion_ees.php?q=
		String query = "http://alchemist.nceas.ucsb.edu/tmosearch/get_results_topic_expansion_ees.php?q=" + "passeriformes";
		System.out.println("query is : " + query);
		String j2 = (String) getRequest(query, "text");	
		System.out.println("j2 is : " + j2);
		String[] temp = new String[100];
		String[] temp3 = new String[100];

		temp = j2.split("\t");
		String temp2 = temp[2].toString();
		temp3 = temp2.split(" ");
		System.out.println("index 0: " + temp[0].toString());		
		System.out.println("1: " + temp[1].toString());
		System.out.println("2: " + temp[2].toString());
		System.out.println("temp3: " + temp3.toString());
		String search = "";
		String search2 = "";
		for(int i = 2; i< temp3.length; i++){

			search2 = temp3[i].replace("<br/>","");
			expansions.put(search2);

		}
		System.out.println("final search: " + expansions.toString());
		return expansions.toString();
	}

	public static JSONArray getDiff(JSONObject objVocab,JSONObject  objTopic) throws JSONException{
		System.out.println("got to getDiff**********");
		JSONObject  vocabResults = objVocab.getJSONObject("response");
		JSONArray vocabDocs = (JSONArray) vocabResults.get("docs");

		JSONObject  topicResults = objTopic.getJSONObject("response");
		JSONArray topicDocs = (JSONArray) topicResults.get("docs");

		System.out.println("vocabDocs: " + vocabDocs.toString()); 
		System.out.println("topicDocs: " + topicDocs.toString()); 

		JSONArray diffIds = new JSONArray();
		for(int i = 0 ; i < vocabDocs.length(); i++){

			//System.out.println("doc is : "  +  docs.get(i));
			JSONObject vocabDoc = (JSONObject) vocabDocs.get(i);
			System.out.println("got to loop getDiff**********" + " id: " + vocabDoc.get("id"));

			//System.out.println("title is : "  + doc.get("title"));
			//System.out.println("id is : "  + doc.get("id"));
			boolean match = false;
			for(int j = 0 ; j < topicDocs.length(); j++){
				JSONObject topicDoc = (JSONObject) topicDocs.get(j);
				System.out.println("comparing with" + " id: " + topicDoc.get("id"));
				if(vocabDoc.get("id").equals(topicDoc.get("id"))){
					match = true;
					break;
				}
			}
			System.out.println("first statement out of inner for loop");
			System.out.println("value of match is: " + match);

			if(match == false){
				System.out.println("no match..."); 
				diffIds.put(vocabDoc.get("id"));
			}
		}


		return diffIds;
	}

	@SuppressWarnings("deprecation")
	public static Object getRequest(String query, String resultType){
		System.out.println("**********getRequest");
		try{		
			System.out.println("**********getRequest2");

			//URLEncoder.encode(term, "UTF-8") 
			//String query = "https://www.googleapis.com/freebase/v1/search?query=" + URLEncoder.encode(term, "UTF-8") + "&indent=true&limit=1" + "&key=" + "AIzaSyBuu7a45hYNBYcwTC9DkeXCIHI3_o0fBd0";
			//String query = "https://cn-orc-1.dataone.org/cn/v1/query/solr/?q=keywords:*ecology*&wt=json&indent=true&rows=10000000";
			System.out.println("dataOne GET query is : " + query);
			//UrlValidator urlValidator = new UrlValidator();
			//System.out.println("valid?: " + urlValidator.isValid(query));

			//JSONObject freebaseConcept = new JSONObject();
			BufferedReader br = null;
			try{
				System.out.println("**********getRequest3");

				URL requestURL = new URL(query);
				System.out.println("requestURL : " + requestURL.toURI().toString());
				//URLConnection conn = requestURL.openConnection();
				HttpURLConnection conn = (HttpURLConnection) requestURL.openConnection();
				conn.setReadTimeout(50000);
				//String contentType = conn.getContentType();
				//System.out.println("connType : " + contentType);
				try{
					System.out.println("**********getRequest4");

					InputStream o = (InputStream)conn.getContent();
					InputStreamReader isr = new InputStreamReader(o);
					br = new BufferedReader(isr);
				}
				catch(Exception e){ e.printStackTrace();
				System.out.println("**********getRequest5");

				JSONObject error = new JSONObject();
				error.put("error", "test");
				return error;
				}
			}
			catch (UnsupportedEncodingException e) {
				System.out.println("**********getRequest6");

				e.printStackTrace();
			} 
			catch (MalformedURLException e) {
				System.out.println("**********getRequest7");

				e.printStackTrace();
			}
			String result="";
			String line;
			while((line=br.readLine())!=null) result += line;		
			System.out.println("**********getRequest8");

			System.out.println("result: " + result);
			System.out.println("**********getRequest9");

			//br.close();
			//System.out.println("full string is: " + result.toString());
			//System.out.println("(WebServiceRequestHandler) freebase result is : " + result);

			if(resultType.equals("json")){
				System.out.println("**********getRequest10");

				JSONObject content = new JSONObject(result);
				System.out.println("content: " + content.toString());

				if(content.has("error")){
					return content;
				}
				else{
					//JSONArray j = (JSONArray) content.get("result");
					//JSONObject jp = (JSONObject) j.get(0);
					return content;		
				}
			}

			if(resultType.equals("text")){
				//JSONObject content = new JSONObject(result);
				System.out.println("content: " + result.toString());
				return result.toString();		

			}

		}
		catch(Exception e){
		}


		return null;
	}

}
